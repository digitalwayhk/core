{"version":3,"sources":["src/pages/Callback/index.tsx"],"sourcesContent":["import React, { useEffect, useState } from 'react';\nimport { history, useModel } from '@umijs/max';\nimport { Spin, Result, Button, Card, Descriptions, Alert } from 'antd';\nimport { LoadingOutlined, CheckCircleOutlined, CloseCircleOutlined } from '@ant-design/icons';\nimport { fetchCasdoorConfig, handleSigninCallback } from '@/config/casdoor';\n\n/**\n * Ëß£Êûê JWT Token Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ\n */\nconst parseJwtToken = (token: string) => {\n  try {\n    const parts = token.split('.');\n    if (parts.length !== 3) {\n      throw new Error('Invalid JWT token format');\n    }\n\n    // Ëß£Á†Å payload (Á¨¨‰∫åÈÉ®ÂàÜ)\n    const payload = parts[1];\n    const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));\n    const claims = JSON.parse(decoded);\n\n    console.log('===== JWT Token Ëß£ÊûêÁªìÊûú =====');\n    console.log('Claims:', claims);\n\n    return claims;\n  } catch (error) {\n    console.error('JWT Token Ëß£ÊûêÂ§±Ë¥•:', error);\n    throw new Error('Token Ëß£ÊûêÂ§±Ë¥•');\n  }\n};\n\n/**\n * Â∞Ü JWT Claims ËΩ¨Êç¢‰∏∫Áî®Êà∑‰ø°ÊÅØÊ†ºÂºè\n */\nconst convertClaimsToUserInfo = (claims: any): API.CurrentUser => {\n  return {\n    userid: claims.id || claims.sub,\n    name: claims.name || claims.displayName,\n    email: claims.email,\n    avatar: claims.avatar,\n    signature: claims.bio,\n    title: claims.title,\n    group: claims.owner,\n    tags: [],\n    notifyCount: 0,\n    unreadCount: 0,\n    country: claims.country || claims.region,\n    access: 'user', // Â¶ÇÊûú isAdmin ‰∏∫ trueÔºåÂèØ‰ª•ËÆæÁΩÆ‰∏∫ 'admin'\n    geographic: {\n      province: { label: '', key: '' },\n      city: { label: '', key: '' },\n    },\n    address: claims.location || '',\n    phone: claims.phone || '',\n  };\n};\n\nconst Callback: React.FC = () => {\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [debugInfo, setDebugInfo] = useState<any>({});\n  const { setInitialState } = useModel('@@initialState');\n\n  useEffect(() => {\n    const processCallback = async () => {\n\n      try {\n        // 1. ‰ªé URL Ëé∑Âèñ code ÂíåÈ™åËØÅ state\n\n        const { code, state } = handleSigninCallback();\n\n        // 2. ÊûÑÂª∫ÂêéÁ´ØÂõûË∞É URL\n        const config=await fetchCasdoorConfig()\n        const backendBaseUrl = window.location.origin; // Ëá™Âä®Ëé∑ÂèñÂΩìÂâçËøêË°åÁöÑÂú∞ÂùÄ\n        const typeUrl=config.ismanage?'&type=manage':''\n        const callbackUrl = `${config.BackgroundCallbackURL}?code=${code}&state=${state}${typeUrl}`;\n        const backendCallbackUrl = `${backendBaseUrl}${callbackUrl}`;\n\n\n        // 3. Ë∞ÉÁî®ÂêéÁ´ØÊç¢Âèñ token\n        const response = await fetch(backendCallbackUrl, {\n          method: 'GET',\n          credentials: 'include',\n          headers: { 'Accept': 'application/json' },\n        });\n        const responseText = await response.text();\n        if (!response.ok) {\n          throw new Error(`ÂêéÁ´ØËøîÂõûÈîôËØØ: ${response.status}`);\n        }\n\n        const data = JSON.parse(responseText);\n\n        if (!data.success || !data.data) {\n          throw new Error('ÂêéÁ´ØÊú™ËøîÂõûÊúâÊïàÁöÑ token');\n        }\n\n        const token = data.data;\n        //4„ÄÅ ‰øùÂ≠ò token Âà∞ localStorage\n        localStorage.setItem('casdoor_token', token);\n\n        const claims = parseJwtToken(token);\n        const userInfo = convertClaimsToUserInfo(claims);\n        // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ\n        localStorage.setItem('casdoor_user', JSON.stringify(userInfo));\n\n        // 5. Êõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅ\n        await setInitialState((s) => ({\n          ...s,\n          currentUser: userInfo,\n        }));\n\n        // 6. Ë∑≥ËΩ¨ÂõûÂéüÈ°µÈù¢\n        const redirectUrl = sessionStorage.getItem('redirect_url') || '/';\n        sessionStorage.removeItem('redirect_url');\n\n\n        console.log('‚úÖ ÁôªÂΩïÊàêÂäüÔºå10ÊØ´ÁßíÂêéË∑≥ËΩ¨Âà∞:', redirectUrl);\n\n        setTimeout(() => {\n          history.push(redirectUrl);\n        }, 10);\n\n      } catch (err: any) {\n        console.error('===== Êï¥‰ΩìÂ§ÑÁêÜÂ§±Ë¥• =====');\n        console.error('Error:', err);\n        setError(err.message || 'ÁôªÂΩïÂ§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');\n        setLoading(false);\n      }\n    };\n\n    processCallback();\n  }, [setInitialState]);\n\n  // ...existing code... (‰øùÊåÅ UI ÈÉ®ÂàÜ‰∏çÂèò)\n\n  if (loading && !error) {\n    return (\n      <div\n        style={{\n          display: 'flex',\n          justifyContent: 'center',\n          alignItems: 'center',\n          minHeight: '100vh',\n          padding: '24px',\n          backgroundColor: '#f0f2f5',\n        }}\n      >\n        <Card\n          title=\"ÁôªÂΩïÂõûË∞ÉÂ§ÑÁêÜ‰∏≠\"\n          style={{ width: '100%', maxWidth: 900 }}\n          extra={<Spin indicator={<LoadingOutlined style={{ fontSize: 24 }} spin />} />}\n        >\n        </Card>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div\n        style={{\n          display: 'flex',\n          justifyContent: 'center',\n          alignItems: 'center',\n          minHeight: '100vh',\n          padding: '24px',\n          backgroundColor: '#f0f2f5',\n        }}\n      >\n        <Card style={{ width: '100%', maxWidth: 900 }}>\n          <Result\n            status=\"error\"\n            title=\"ÁôªÂΩïÂ§±Ë¥•\"\n            subTitle={error}\n            extra={[\n              <Button\n                type=\"primary\"\n                key=\"retry\"\n                onClick={() => {\n                  sessionStorage.removeItem('redirect_url');\n                  history.push('/user/login');\n                }}\n              >\n                ËøîÂõûÁôªÂΩï\n              </Button>,\n            ]}\n          />\n\n          {debugInfo.logs && (\n            <div style={{ marginTop: 24, textAlign: 'left' }}>\n              <h3>üîç ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØÔºö</h3>\n              <pre style={{\n                padding: 12,\n                backgroundColor: '#fff2f0',\n                borderRadius: 4,\n                fontSize: 11,\n                overflow: 'auto',\n                border: '1px solid #ffccc7',\n                maxHeight: 500,\n              }}>\n                {JSON.stringify(debugInfo, null, 2)}\n              </pre>\n            </div>\n          )}\n        </Card>\n      </div>\n    );\n  }\n\n  return null;\n};\n\nexport default Callback;\n"],"names":[],"mappings":"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"}